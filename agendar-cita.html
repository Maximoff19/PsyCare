<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendar Cita - PsyCare</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Menú Lateral -->
        <nav class="sidebar">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-brain"></i>
                </div>
                <div class="logo-text">
                    <h1>PsyCare</h1>
                    <p>Panel de Paciente</p>
                </div>
            </div>
            <ul class="nav-links">
                <li><a href="paciente.html"><i class="fas fa-home"></i> Inicio</a></li>
                <li class="active"><a href="mis-citas.html"><i class="fas fa-calendar"></i> Mis Citas</a></li>
                <li><a href="mis-evaluaciones.html"><i class="fas fa-clipboard-list"></i> Mis Evaluaciones</a></li>
                <li><a href="mi-progreso.html"><i class="fas fa-chart-line"></i> Mi Progreso</a></li>
                <li><a href="recursos.html"><i class="fas fa-book"></i> Recursos</a></li>
                <li><a href="ajustes-paciente.html"><i class="fas fa-cog"></i> Ajustes</a></li>
                <li><a href="#" id="logout"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a></li>
            </ul>
        </nav>

        <!-- Contenido Principal -->
        <main class="main-content">
            <header class="top-bar">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Buscar...">
                </div>
                <div class="user-profile">
                    <img src="https://via.placeholder.com/40" alt="Perfil">
                    <span id="userName">Cargando...</span>
                </div>
            </header>

            <div class="dashboard">
                <!-- Formulario de Agendar Cita -->
                <div class="panel">
                    <div class="section-header">
                        <h2>Agendar Nueva Cita</h2>
                    </div>
                    <form id="appointmentForm" class="settings-form">
                        <div class="form-group">
                            <label for="sessionType">Tipo de Sesión</label>
                            <select id="sessionType" required>
                                <option value="">Selecciona el tipo de sesión</option>
                                <option value="Terapia Individual">Terapia Individual</option>
                                <option value="Terapia de Pareja">Terapia de Pareja</option>
                                <option value="Terapia Familiar">Terapia Familiar</option>
                                <option value="Consulta de Seguimiento">Consulta de Seguimiento</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="psychologistEmail">Correo del Psicólogo</label>
                            <input type="email" id="psychologistEmail" required placeholder="correo@psicologo.com">
                        </div>

                        <div class="form-group">
                            <label for="date">Fecha</label>
                            <input type="date" id="date" required>
                        </div>

                        <div class="form-group">
                            <label for="time">Hora</label>
                            <select id="time" required>
                                <option value="">Selecciona la hora</option>
                                <option value="09:00">09:00 AM</option>
                                <option value="10:00">10:00 AM</option>
                                <option value="11:00">11:00 AM</option>
                                <option value="12:00">12:00 PM</option>
                                <option value="15:00">03:00 PM</option>
                                <option value="16:00">04:00 PM</option>
                                <option value="17:00">05:00 PM</option>
                                <option value="18:00">06:00 PM</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="modality">Modalidad</label>
                            <select id="modality" required>
                                <option value="">Selecciona la modalidad</option>
                                <option value="Presencial">Presencial</option>
                                <option value="Virtual">Virtual</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="duration">Duración</label>
                            <select id="duration" required>
                                <option value="">Selecciona la duración</option>
                                <option value="30">30 minutos</option>
                                <option value="45">45 minutos</option>
                                <option value="60">60 minutos</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="notes">Notas Adicionales</label>
                            <textarea id="notes" rows="4" placeholder="Agrega cualquier información adicional que consideres importante"></textarea>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-calendar-plus"></i> Agendar Cita
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Horarios Disponibles -->
                <div class="panel">
                    <div class="section-header">
                        <h2>Horarios Disponibles</h2>
                    </div>
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <button class="btn-icon" onclick="previousMonth()">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <h3 id="currentMonth">Marzo 2024</h3>
                            <button class="btn-icon" onclick="nextMonth()">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="calendar-grid" id="calendarGrid">
                            <!-- El calendario se generará dinámicamente -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <button class="theme-toggle" id="themeToggle">
        <i class="fas fa-moon"></i>
    </button>

    <script src="script.js"></script>
    <script type="module">
        import { auth, db } from './firebase-config.js';
        import { 
            collection, 
            addDoc, 
            query, 
            where, 
            getDocs,
            doc,
            getDoc
        } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

        // Función para cargar los datos del usuario
        async function loadUserData() {
            const user = auth.currentUser;
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    document.getElementById('userName').textContent = userDoc.data().fullName;
                }
            }
        }

        // Manejo del formulario de agendar cita
        const appointmentForm = document.getElementById('appointmentForm');
        if (appointmentForm) {
            appointmentForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const user = auth.currentUser;
                if (!user) {
                    alert('Debes iniciar sesión para agendar una cita');
                    return;
                }

                const psychologistEmail = document.getElementById('psychologistEmail').value;
                
                // Buscar el psicólogo por su correo
                const q = query(
                    collection(db, "users"),
                    where("email", "==", psychologistEmail),
                    where("role", "==", "psychologist")
                );

                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    alert('No se encontró ningún psicólogo con ese correo electrónico');
                    return;
                }

                const psychologistDoc = querySnapshot.docs[0];
                const appointmentData = {
                    psychologistId: psychologistDoc.id,
                    patientId: user.uid,
                    patientEmail: user.email,
                    date: document.getElementById('date').value,
                    time: document.getElementById('time').value,
                    sessionType: document.getElementById('sessionType').value,
                    modality: document.getElementById('modality').value,
                    duration: document.getElementById('duration').value,
                    notes: document.getElementById('notes').value,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };

                try {
                    await addDoc(collection(db, "appointments"), appointmentData);
                    alert('Cita agendada exitosamente');
                    window.location.href = 'mis-citas.html';
                } catch (error) {
                    console.error("Error al agendar la cita:", error);
                    alert('Error al agendar la cita');
                }
            });
        }

        // Inicializar la aplicación cuando el DOM esté cargado
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar si el usuario está autenticado
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // Cargar datos del usuario
                    await loadUserData();
                } else {
                    // Redirigir al login si no hay usuario autenticado
                    window.location.href = 'login.html';
                }
            });
        });
    </script>
</body>
</html> 